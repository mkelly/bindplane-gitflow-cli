name: BindPlane OP Deploy Raw
on:
  workflow_dispatch:
  push:
    branches:
      - main
      - dev

jobs:
  bindplane:
    runs-on: "ubuntu-22.04"
    steps:
      - name: Check out source code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - run: mkdir download

      - name: Install BindPlane CLI
        run: |
          curl -o bindplane.zip https://storage.googleapis.com/bindplane-op-releases/bindplane/bindplane-ee-v1.30.0-linux-amd64.zip
          unzip bindplane.zip
          sudo chmod +x bindplane
          sudo mv bindplane /usr/local/bin/bindplane
        working-directory: download

      - name: Create Profile
        run: |
          bindplane profile set mk \
            --remote-url https://app.bindplane.com \
            --api-key ${{ secrets.BINDPLANE_API_KEY }}
          bindplane profile use mk

      - name: Test CLI
        run: bindplane version

      - name: Install yq
        run: |
          sudo apt-get update
          sudo apt-get install -y snapd
          sudo snap install yq

      - name: Run merge script
        run: |
          bash ./merge_yaml.sh
      
      - name: List output directory contents
        run: ls -R ./output/

      - name: Deploy Resources using Bindplane CLI
        run: |
          for file in output/*.yaml; do
            bindplane apply -f $file
          done
